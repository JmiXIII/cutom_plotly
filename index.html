<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My Grist Chart Widget</title>
    <!-- Include Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <!-- Create a container element for the chart -->
    <div class="chart-container" style="position: relative">
      <canvas id="myChart"></canvas>
    </div>
    +
    <div id="myDiv"></div>

    <script>
      // Wait for the Grist API to be ready
      grist.ready({
        columns: ["Date", "Result", "Target"],
        requiredAccess: "read table",
      });

      const plotDiv = document.getElementById("myDiv");

      // Set the height and width of the Plotly chart to match the iframe
      const layout = {
        autosize: true,
        margin: {
          l: 5,
          r: 5,
          b: 5,
          t: 5,
          pad: 0,
        },
      };

      const config = {
        displayModeBar: true, // this is the line that hides the bar.
        responsive: true,
      };

      // When a new record is selected in the Grist table, render a chart based on its data
      grist.onRecords(function (records, mappings) {
        let mapped = grist.mapColumnNames(records);
        if (mapped) {
          // mJson = mapped Json from mapped column
          let mResults = mapped.map(({ Result, Date }) => ({ Result, Date }));
          let mTargets = mapped.map(({ Target, Date }) => ({ Target, Date }));
          mTargets.sort((a, b) => {
            return a.Date - b.Date;
          });

          let traceResult = {
            x: mResults.map((obj) => obj.Date),
            y: mResults.map((obj) => obj.Result),
            type: "bar",
          };
          let traceTarget = {
            x: mTargets.map((obj) => obj.Date),
            y: mTargets.map((obj) => obj.Target),
            type: "scatter",
          };

          let data = [traceResult, traceTarget];
          Plotly.newPlot("myDiv", data, layout, config);

          let ctx = document.getElementById("myChart");
          let cDate = mResults.map((x) => x.Date);
          let cResult = mResults.map((x) => x.Result);
          new Chart(ctx, {
            type: "bar",
            option: { maintainAspectRatio: false },
            data: {
              labels: cDate,
              datasets: [
                {
                  label: "My First Dataset",
                  data: cResult,
                  borderColor: "rgb(255, 99, 132)",
                },
              ],
            },
            options: {  maintainAspectRatio: false,},
          });
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>

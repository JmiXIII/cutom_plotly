<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>onRecord</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  </head>
  <body>
    <pre id="readout">Waiting for data...</pre>
    <img id="image" src="" />

    <!-- Create a container element for the chart -->
    <div id="chart-container"></div>
    <div id="title"></div>
    <script>
      grist.ready({
        columns: ["Date", "Result", "Target"],
        requiredAccess: "read table",
      });
      grist.onRecord(function (record, mappings) {
        const mapped = grist.mapColumnNames(record);
        // First check if all columns were mapped.
        if (mapped) {
          const data = grist.docApi.fetchTable().then((resp) => {
            results = resp.Result;
            dated = resp.Date.map((x) => x[1]).map((x) => new Date(x * 1000));
            target = resp.Target;
            // Define the trace for the chart
            const traceResult = {
              y: results,
              x: dated,
              type: "bar",
            };

            console.log("date --> ", dated);
            console.log("results --> ", results);

            const traceTarget = {
              y: target,
              x: dated,
              type: "line",
            };

            const data = [traceResult, traceTarget];

            // Define the layout of the chart
            // Create the chart using Plotly.js
            Plotly.newPlot("chart-container", data);
          });
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My Grist Chart Widget</title>
    <!-- Include Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.1/lodash.min.js"></script>
  </head>

  <body>
    <!-- Create a container element for the chart -->
    <div id="chart-container"></div>
    <pre id="readout">Waiting for data...</pre>
    <pre id="target">waiting for target data</pre>
    <pre id="result">waiting for result data</pre>
    <script>
      // Wait for the Grist API to be ready
      grist.ready({
        columns: ["Date", "Result", "Target"],
        requiredAccess: "read table",
      });
      // When a new record is selected in the Grist table, render a chart based on its data
      grist.onRecords(function (records, mappings) {
        var mapped = grist.mapColumnNames(records);
        if (mapped) {
          datas = JSON.stringify(records, null, 2);
          var targets = _.chain(records)
            .map((item) => ({
              id: item?.id,
              Date: item?.Date,
              Target: item?.Target,
            }))
            .value();
          var results = _.chain(records)
            .map((item) => ({
              id : item?.id,
              Date: item?.Date,
              Result: item?.Result
            }))
            .value();

          var results = records['Date'];
          document.getElementById("result").innerHTML = JSON.stringify(results,null,2);
          document.getElementById("target").innerHTML = JSON.stringify(targets,null,2);
          document.getElementById("readout").innerHTML = JSON.stringify(records,null,2 );
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>
